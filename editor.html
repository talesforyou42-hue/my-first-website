<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manhwa Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;touch-action:none}

body{
  margin:0;
  font-family:"Segoe UI", Arial, sans-serif;
  min-height:100vh;
  background:
    radial-gradient(circle at 10% 20%, #ff9a9e, transparent 40%),
    radial-gradient(circle at 90% 30%, #fad0c4, transparent 40%),
    radial-gradient(circle at 50% 80%, #fbc2eb, transparent 45%),
    linear-gradient(135deg,#a18cd1,#fbc2eb);
  overflow-x:hidden;
}

.page-wrapper{
  display:flex;
  justify-content:center;
  padding:90px 20px 90px;
  width:100%;
}

.page{
  background:white;
  width:380px;
  min-height:85vh;
  border-radius:20px;
  padding:14px;
  box-shadow:0 20px 30px rgba(0,0,0,0.25);
}

.topbar{
  position:fixed;
  top:0;left:0;
  width:100%;
  padding:16px;
  text-align:center;
  color:white;
  font-size:1.4rem;
  font-weight:700;
}

/* PANEL */
.panel{
  width:100%;
  min-height:220px;
  border:2px solid #000;
  border-radius:10px;
  margin-bottom:16px;
  position:relative;
  overflow:hidden;
  background:#eeeeee;
  touch-action:none;
  transition:border .15s;
}
.panel.dragging{
  opacity:0.6;
  border-color:#ff5f6d;
}

/* BG */
.bg-layer{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  z-index:1;
}

/* CHARACTER */
.char-img{
  position:absolute;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  max-height:95%;
  z-index:2;
}

/* CAPTION */
.caption{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  padding:8px 10px;
  min-height:46px;
  background:rgba(0,0,0,0.7);
  color:white;
  font-size:0.95rem;
  z-index:4;
}

/* TOOLS */
.tools{
  position:absolute;
  top:6px;
  left:6px;
  display:flex;
  gap:5px;
  z-index:6;
}
.tools button{
  padding:2px 6px;
  font-size:10px;
  border-radius:4px;
  background:#222;
  color:white;
  border:none;
}

/* HISTORY ABOVE CAPTION */
.history{
  position:absolute;
  bottom:52px;
  left:6px;
  display:flex;
  gap:5px;
  z-index:7;
}
.history button{
  padding:2px 6px;
  font-size:10px;
  background:#444;
  color:white;
  border:none;
  border-radius:4px;
}

/* DELETE */
.delete-panel{
  position:absolute;
  top:6px;
  right:6px;
  background:red;
  color:white;
  border:none;
  font-size:11px;
  padding:3px 6px;
  border-radius:4px;
  z-index:7;
}

/* FULL RESIZE HANDLE */
.resize-handle{
  position:absolute;
  bottom:0;
  right:0;
  width:22px;
  height:22px;
  background:#aaa;
  border-top-left-radius:6px;
  cursor:nwse-resize;
  z-index:10;
}

/* ADD BUTTON */
.add-panel{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:24px;
  background:#ff5f6d;
  color:white;
  font-size:1rem;
  font-weight:700;
}

/* INPUT BAR */
.input-bar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  padding:10px;
  display:flex;
  gap:8px;
  border-top:2px solid #ccc;
  background:white;
}
.input-bar input{
  flex:1;
  padding:12px;
  border-radius:25px;
  border:1px solid #ccc;
  font-size:1rem;
  outline:none;
}
.input-bar button{
  padding:12px 20px;
  border-radius:25px;
  border:none;
  background:#ff5f6d;
  font-weight:700;
  color:white;
}
</style>
</head>

<body>

<div class="topbar">ðŸ“œ Create Your Manhwa</div>

<div class="page-wrapper">
  <div class="page" id="page">
    <button class="add-panel" onclick="addPanel()">+ Add Scene</button>
  </div>
</div>

<div class="input-bar">
  <input id="scene-text" placeholder="Write your scene...">
  <button onclick="createFromText()">Create</button>
</div>

<script>
let history=[], redoStack=[];

/* SAVE SNAPSHOT */
function snapshot(){
  const state=localStorage.getItem("manhwa");
  if(state){
    history.push(state);
    redoStack=[];
    if(history.length>50)history.shift();
  }
}

/* UNDO & REDO */
function undo(){ if(!history.length)return;
  redoStack.push(localStorage.getItem("manhwa"));
  localStorage.setItem("manhwa",history.pop());
  reload();
}
function redo(){ if(!redoStack.length)return;
  history.push(localStorage.getItem("manhwa"));
  localStorage.setItem("manhwa",redoStack.pop());
  reload();
}

/* BUILD PANEL */
function newPanel(data={}){
  const p=document.createElement("div");
  p.className="panel";

  const bg=document.createElement("div");
  bg.className="bg-layer";
  if(data.bg) bg.style.backgroundImage=`url(${data.bg})`;

  const cap=document.createElement("div");
  cap.className="caption";
  cap.innerText=data.text||"New sceneâ€¦";

  const tools=document.createElement("div");
  tools.className="tools";
  tools.innerHTML=`<button onclick="addBG(this)">BG</button>
                   <button onclick="addChar(this)">CHR</button>`;

  const hist=document.createElement("div");
  hist.className="history";
  hist.innerHTML=`<button onclick="undo()">â†¶</button>
                  <button onclick="redo()">â†·</button>`;

  const del=document.createElement("button");
  del.className="delete-panel";
  del.innerText="x";
  del.onclick=()=>{p.remove();saveAll();};

  const resize=document.createElement("div");
  resize.className="resize-handle";

  p.append(bg,tools,hist,cap,del,resize);

  /* apply character if exists */
  if(data.char){
    const img=document.createElement("img");
    img.src=data.char;
    img.className="char-img";
    p.appendChild(img);
  }

  enableDrag(p);
  enableResize(p);

  return p;
}

/* ADD PANEL */
function addPanel(data={}){
  const pg=document.getElementById("page");
  const btn=document.querySelector(".add-panel");
  pg.insertBefore(newPanel(data),btn);
  saveAll();
}

/* CREATE FROM TEXT */
function createFromText(){
  const input=document.getElementById("scene-text");
  if(!input.value.trim())return;
  addPanel({text:input.value});
  input.value="";
}

/* UPLOAD BG */
function addBG(btn){
  const p=btn.closest(".panel");
  const bg=p.querySelector(".bg-layer");
  const file=document.createElement("input");
  file.type="file";file.accept="image/*";
  file.onchange=e=>{
    snapshot();
    const r=new FileReader();
    r.onload=x=>{bg.style.backgroundImage=`url(${x.target.result})`;saveAll();};
    r.readAsDataURL(e.target.files[0]);
  };
  file.click();
}

/* ADD CHARACTER */
function addChar(btn){
  const p=btn.closest(".panel");
  const file=document.createElement("input");
  file.type="file";file.accept="image/*";
  file.onchange=e=>{
    snapshot();
    const r=new FileReader();
    r.onload=x=>{
      const img=document.createElement("img");
      img.src=x.target.result;
      img.className="char-img";
      p.appendChild(img);
      saveAll();
    };
    r.readAsDataURL(e.target.files[0]);
  };
  file.click();
}

/* SAVE DATA */
function saveAll(){
  snapshot();
  const arr=[...document.querySelectorAll(".panel")].map(p=>{
    const char=p.querySelector(".char-img");
    return{
      text:p.querySelector(".caption").innerText,
      bg:p.querySelector(".bg-layer").style.backgroundImage.replace('url("','').replace('")',''),
      char:char?char.src:"",
      height:p.style.minHeight
    };
  });
  localStorage.setItem("manhwa",JSON.stringify(arr));
}

/* LOAD */
function reload(){
  document.getElementById("page").innerHTML='<button class="add-panel" onclick="addPanel()">+ Add Scene</button>';
  JSON.parse(localStorage.getItem("manhwa")||"[]").forEach(p=>addPanel(p));
}
reload();

/* ENABLE RESIZE */
function enableResize(panel){
  let startY,startH;
  const h=panel.querySelector(".resize-handle");

  const start=e=>{
    e.preventDefault();
    startY=e.touches?e.touches[0].clientY:e.clientY;
    startH=panel.offsetHeight;
    document.addEventListener("mousemove",move);
    document.addEventListener("touchmove",move,{passive:false});
    document.addEventListener("mouseup",stop);
    document.addEventListener("touchend",stop);
  };
  const move=e=>{
    const y=e.touches?e.touches[0].clientY:e.clientY;
    panel.style.minHeight=Math.max(160,startH+(y-startY))+"px";
  };
  const stop=()=>{
    document.removeEventListener("mousemove",move);
    document.removeEventListener("touchmove",move);
    saveAll();
  };

  h.addEventListener("mousedown",start);
  h.addEventListener("touchstart",start,{passive:false});
}

/* ENABLE DRAG */
function enableDrag(panel){
  let startY;
  const start=e=>{
    if(e.target.classList.contains("resize-handle"))return;
    panel.classList.add("dragging");
    startY=e.touches?e.touches[0].clientY:e.clientY;
    document.addEventListener("mousemove",move);
    document.addEventListener("touchmove",move,{passive:false});
    document.addEventListener("mouseup",stop);
    document.addEventListener("touchend",stop);
  };
  const move=e=>{
    const y=e.touches?e.touches[0].clientY:e.clientY;
    const delta=y-startY;
    panel.style.transform=`translateY(${delta}px)`;
    const all=[...document.querySelectorAll(".panel")];
    all.forEach(p=>{
      if(p!==panel){
        const r=p.getBoundingClientRect();
        if(y>r.top&&y<r.bottom){
          const pg=document.getElementById("page");
          pg.insertBefore(panel,p);
          startY=y;
        }
      }
    });
  };
  const stop=()=>{
    panel.style.transform="";
    panel.classList.remove("dragging");
    saveAll();
    document.removeEventListener("mousemove",move);
    document.removeEventListener("touchmove",move);
  };

  panel.addEventListener("mousedown",start);
  panel.addEventListener("touchstart",start,{passive:false});
}
</script>
</body>
</html>
