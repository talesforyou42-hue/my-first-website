<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manhwa Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;touch-action:none}

body{
  margin:0;
  font-family:"Segoe UI", Arial, sans-serif;
  min-height:100vh;
  background:
    radial-gradient(circle at 10% 20%, #ff9a9e, transparent 40%),
    radial-gradient(circle at 90% 30%, #fad0c4, transparent 40%),
    radial-gradient(circle at 50% 80%, #fbc2eb, transparent 45%),
    linear-gradient(135deg,#a18cd1,#fbc2eb);
  overflow-x:hidden;
}

.page-wrapper{
  display:flex;
  justify-content:center;
  padding:90px 20px 90px;
  width:100%;
}

.page{
  background:white;
  width:380px;
  min-height:85vh;
  border-radius:18px;
  padding:14px;
  box-shadow:0 30px 60px rgba(0,0,0,0.25);
}

.topbar{
  color:white;
  font-weight:700;
  padding:16px;
  font-size:1.4rem;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  text-align:center;
}

/* PANEL */
.panel{
  width:100%;
  min-height:220px;
  border:2px solid #222;
  border-radius:6px;
  margin-bottom:14px;
  position:relative;
  overflow:hidden;
  background:linear-gradient(135deg,#ffffff,#dcdcdc);
  touch-action:none;
}

.bg-layer{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  z-index:1;
}

.char-img{
  position:absolute;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  max-height:95%;
  z-index:2;
}

/* Caption */
.caption{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  background:rgba(0,0,0,0.65);
  color:white;
  padding:8px 10px;
  font-size:0.95rem;
  z-index:3;
}

/* Tools */
.tools{
  position:absolute;
  left:6px;
  top:6px;
  z-index:5;
  display:flex;
  gap:4px;
}
.tools button{
  padding:2px 6px;
  font-size:10px;
  background:#111;
  color:white;
  border:none;
  border-radius:4px;
}

/* Per panel Undo/Redo */
.history-controls{
  position:absolute;
  bottom:26px;
  left:4px;
  display:flex;
  gap:4px;
  z-index:8;
}
.history-controls button{
  padding:2px 6px;
  font-size:10px;
  background:#444;
  color:white;
  border:none;
  border-radius:4px;
}

/* Delete */
.delete-panel{
  position:absolute;
  right:6px;
  top:6px;
  background:red;
  color:white;
  border:none;
  padding:3px 6px;
  font-size:11px;
  border-radius:4px;
  z-index:7;
}

/* Resize both ways */
.resize-bar{
  position:absolute;
  bottom:0;
  right:0;
  width:18px;
  height:18px;
  background:#bbb;
  cursor:nwse-resize;
  z-index:10;
}

/* Drag appearance */
.panel.dragging{
  opacity:0.6;
}

/* Add button */
.add-panel{
  width:100%;
  padding:12px;
  border:none;
  border-radius:24px;
  background:#ff5f6d;
  color:white;
  font-weight:700;
  font-size:1rem;
  margin-top:10px;
}

/* Input bar */
.input-bar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:white;
  border-top:2px solid #ccc;
  padding:10px;
  display:flex;
  gap:8px;
}
.input-bar input{
  flex:1;
  padding:12px;
  border:1px solid #bbb;
  border-radius:25px;
  outline:none;
  font-size:1rem;
}
.input-bar button{
  padding:12px 20px;
  border:none;
  border-radius:25px;
  background:#ff5f6d;
  color:white;
  font-weight:700;
  font-size:1rem;
}
</style>
</head>

<body>

<div class="topbar">ðŸ“œ Create Your Manhwa</div>

<div class="page-wrapper">
  <div class="page" id="page">
    <button class="add-panel" onclick="addPanel()">+ Add Scene</button>
  </div>
</div>

<div class="input-bar">
  <input id="scene-text" type="text" placeholder="Write your scene...">
  <button onclick="createFromText()">Create</button>
</div>

<script>
let resizing=false, resizePanel=null,startX=0,startY=0,startW=0,startH=0;
let dragPanel=null, startPosY=0;
let history=[];
let redoStack=[];

/* PUSH HISTORY */
function pushHistory(){
  const state=localStorage.getItem("manhwa");
  if(state){
    history.push(state);
    redoStack=[];
    if(history.length>60)history.shift();
  }
}

/* PER PANEL UNDO */
function undo(btn){
  if(history.length===0)return;
  redoStack.push(localStorage.getItem("manhwa"));
  const last=history.pop();
  localStorage.setItem("manhwa",last);
  reload();
}

/* PER PANEL REDO */
function redo(btn){
  if(redoStack.length===0)return;
  history.push(localStorage.getItem("manhwa"));
  const next=redoStack.pop();
  localStorage.setItem("manhwa",next);
  reload();
}

/* BUILD NEW PANEL */
function newPanel(data={}){
  const panel=document.createElement("div");
  panel.className="panel";
  panel.style.minHeight=data.height||"220px";

  panel.addEventListener("mousedown",startDrag);
  panel.addEventListener("touchstart",startDrag,{passive:false});

  const bg=document.createElement("div");
  bg.className="bg-layer";
  if(data.bg) bg.style.backgroundImage=`url(${data.bg})`;

  const caption=document.createElement("div");
  caption.className="caption";
  caption.innerText=data.text||"New sceneâ€¦";

  const tools=document.createElement("div");
  tools.className="tools";
  tools.innerHTML=`<button onclick="uploadBG(this)">BG</button>
                   <button onclick="uploadChar(this)">CHR</button>`;

  const controls=document.createElement("div");
  controls.className="history-controls";
  controls.innerHTML=`<button onclick="undo()">â†¶</button>
                      <button onclick="redo()">â†·</button>`;

  const del=document.createElement("button");
  del.className="delete-panel";
  del.innerText="x";
  del.onclick=()=>{panel.remove();saveAll();};

  const resize=document.createElement("div");
  resize.className="resize-bar";
  resize.addEventListener("mousedown",startResize);
  resize.addEventListener("touchstart",startResize,{passive:false});

  panel.appendChild(bg);
  panel.appendChild(tools);
  panel.appendChild(controls);
  panel.appendChild(caption);
  panel.appendChild(del);
  panel.appendChild(resize);

  if(data.char){
    const img=document.createElement("img");
    img.src=data.char;
    img.className="char-img";
    panel.appendChild(img);
  }

  return panel;
}

/* ADD PANEL */
function addPanel(data={}){
  const page=document.getElementById("page");
  const btn=document.querySelector(".add-panel");
  const panel=newPanel(data);
  page.insertBefore(panel,btn);
  saveAll();
}

/* INPUT CREATE */
function createFromText(){
  const input=document.getElementById("scene-text");
  const text=input.value.trim();
  if(!text)return;
  addPanel({text});
  input.value="";
  saveAll();
}

/* BG UPLOAD */
function uploadBG(btn){
  const panel=btn.closest(".panel");
  const bg=panel.querySelector(".bg-layer");
  const input=document.createElement("input");
  input.type="file";input.accept="image/*";
  input.onchange=e=>{
    pushHistory();
    const reader=new FileReader();
    reader.onload=ev=>{bg.style.backgroundImage=`url(${ev.target.result})`;saveAll();};
    reader.readAsDataURL(e.target.files[0]);
  };
  input.click();
}

/* CHAR UPLOAD */
function uploadChar(btn){
  const panel=btn.closest(".panel");
  const input=document.createElement("input");
  input.type="file";input.accept="image/*";
  input.onchange=e=>{
    pushHistory();
    const reader=new FileReader();
    reader.onload=ev=>{
      const img=document.createElement("img");
      img.src=ev.target.result;
      img.className="char-img";
      panel.appendChild(img);
      saveAll();
    };
    reader.readAsDataURL(e.target.files[0]);
  };
  input.click();
}

/* SAVE */
function saveAll(){
  pushHistory();
  const data=[...document.querySelectorAll(".panel")].map(p=>{
    const char=p.querySelector(".char-img");
    return{
      text:p.querySelector(".caption").innerText,
      bg:p.querySelector(".bg-layer").style.backgroundImage.replace('url("','').replace('")',''),
      char:char?char.src:"",
      height:p.style.minHeight,
    };
  });
  localStorage.setItem("manhwa",JSON.stringify(data));
}

/* LOAD */
function reload(){
  document.getElementById("page").innerHTML='<button class="add-panel" onclick="addPanel()">+ Add Scene</button>';
  JSON.parse(localStorage.getItem("manhwa")||"[]").forEach(p=>addPanel(p));
}
reload();

/* RESIZE BOTH DIRECTIONS */
function startResize(e){
  e.preventDefault();
  resizePanel=this.parentNode;
  resizing=true;
  startX=e.touches?e.touches[0].clientX:e.clientX;
  startY=e.touches?e.touches[0].clientY:e.clientY;
  startW=resizePanel.offsetWidth;
  startH=resizePanel.offsetHeight;
}

document.addEventListener("mousemove",e=>{
  if(!resizing)return;
  const dx=e.clientX-startX;
  const dy=e.clientY-startY;
  resizePanel.style.minHeight=Math.max(160,startH+dy)+"px";
});

document.addEventListener("touchmove",e=>{
  if(!resizing)return;
  const dx=e.touches[0].clientX-startX;
  const dy=e.touches[0].clientY-startY;
  resizePanel.style.minHeight=Math.max(160,startH+dy)+"px";
});

document.addEventListener("mouseup",()=>{resizing=false;saveAll();});
document.addEventListener("touchend",()=>{resizing=false;saveAll();});

/* DRAG REORDER */
function startDrag(e){
  if(e.target.classList.contains("resize-bar"))return;
  dragPanel=this;
  dragPanel.classList.add("dragging");
  startPosY=e.touches?e.touches[0].clientY:e.clientY;
  document.addEventListener("mousemove",dragMove);
  document.addEventListener("touchmove",dragMove,{passive:false});
  document.addEventListener("mouseup",stopDrag);
  document.addEventListener("touchend",stopDrag);
}

function dragMove(e){
  const y=e.touches?e.touches[0].clientY:e.clientY;
  const delta=y-startPosY;
  dragPanel.style.transform=`translateY(${delta}px)`;

  const panels=[...document.querySelectorAll(".panel")];
  panels.forEach(p=>{
    if(p!==dragPanel){
      const rect=p.getBoundingClientRect();
      if(y>rect.top && y<rect.bottom){
        const page=document.getElementById("page");
        page.insertBefore(dragPanel,p);
        startPosY=y;
      }
    }
  });
}

function stopDrag(){
  dragPanel.style.transform="";
  dragPanel.classList.remove("dragging");
  dragPanel=null;
  saveAll();
  document.removeEventListener("mousemove",dragMove);
  document.removeEventListener("touchmove",dragMove);
  document.removeEventListener("mouseup",stopDrag);
  document.removeEventListener("touchend",stopDrag);
}
</script>
</body>
</html>
