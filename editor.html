<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manhwa Free Canvas Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;touch-action:none}

body{
  margin:0;
  font-family:"Segoe UI", Arial, sans-serif;
  min-height:100vh;
  background:
    radial-gradient(circle at 10% 20%, #ff9a9e, transparent 40%),
    radial-gradient(circle at 90% 30%, #fad0c4, transparent 40%),
    radial-gradient(circle at 50% 80%, #fbc2eb, transparent 45%),
    linear-gradient(135deg,#a18cd1,#fbc2eb);
  overflow:hidden;
}

/* FULL FREE LAYOUT */
.canvas{
  position:relative;
  width:100%;
  height:100vh;
  overflow:auto;
  padding:80px 0 100px;
}

/* TOP BAR */
.topbar{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  padding:16px;
  text-align:center;
  color:white;
  font-size:1.4rem;
  font-weight:700;
  z-index:1000;
  background:rgba(0,0,0,0.25);
}

/* PANEL (free movable box) */
.panel{
  position:absolute;
  top:120px;
  left:20px;
  width:300px;
  height:220px;
  border:2px solid black;
  border-radius:10px;
  overflow:hidden;
  background:#eeeeee;
  z-index:10;
  transition:border .15s;
}
.panel.dragging{opacity:.6;border-color:#ff5f6d}

/* BG */
.bg-layer{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  z-index:1;
}

/* CHARACTER IMG */
.char-img{
  position:absolute;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  max-height:95%;
  z-index:2;
}

/* CAPTION TEXT */
.caption{
  position:absolute;
  bottom:0;
  width:100%;
  background:rgba(0,0,0,0.65);
  color:white;
  padding:6px;
  font-size:.95rem;
  z-index:3;
  pointer-events:none;
}

/* SPEECH BUBBLE */
.bubble{
  position:absolute;
  max-width:75%;
  background:white;
  padding:6px;
  border-radius:10px;
  font-size:.85rem;
  z-index:15;
  border:2px solid black;
}

/* TOOLS */
.tools{
  position:absolute;
  top:6px;
  left:6px;
  display:flex;
  gap:5px;
  z-index:20;
}
.tools button{
  padding:2px 6px;
  font-size:10px;
  background:#222;
  color:white;
  border:none;
  border-radius:3px;
}

/* DELETE */
.delete-panel{
  position:absolute;
  top:6px;
  right:6px;
  background:red;
  color:white;
  border:none;
  font-size:11px;
  padding:3px 6px;
  border-radius:4px;
  z-index:20;
}

/* UNDO/REDO */
.history{
  position:absolute;
  bottom:46px;
  left:6px;
  display:flex;
  gap:5px;
  z-index:20;
}
.history button{
  padding:2px 6px;
  font-size:10px;
  background:#444;
  color:white;
  border:none;
  border-radius:4px;
}

/* 4 CORNER RESIZE */
.resize{
  width:15px;height:15px;
  position:absolute;
  background:#666;
  z-index:30;
}
.resize.br{right:0;bottom:0;cursor:nwse-resize;}
.resize.bl{left:0;bottom:0;cursor:nesw-resize;}
.resize.tr{right:0;top:0;cursor:nesw-resize;}
.resize.tl{left:0;top:0;cursor:nwse-resize;}

/* INPUT BAR bottom */
.input-bar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  padding:10px;
  background:#fff;
  border-top:2px solid #ccc;
  display:flex;
  gap:8px;
}
.input-bar input{
  flex:1;
  padding:12px;
  border-radius:25px;
  border:1px solid #ccc;
  outline:none;
}
.input-bar button{
  padding:12px 20px;
  border-radius:25px;
  border:none;
  background:#ff5f6d;
  font-weight:700;
  color:white;
}
</style>
</head>

<body>

<div class="topbar">
  ðŸ“œ Create Your Manhwa
  <button onclick="exportPNG()" style="margin-left:12px;padding:4px 10px;border:none;border-radius:6px;background:#fff;font-size:.8rem;">ðŸ“¥ Export PNG</button>
</div>

<div class="canvas" id="canvas"></div>

<!-- INPUT BAR -->
<div class="input-bar">
  <input id="scene" placeholder="Write your scene...">
  <button onclick="addPanel()">Add</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
let undoStack=[],redoStack=[];

/* SNAPSHOT */
function snapshot(){
  undoStack.push(document.getElementById("canvas").innerHTML);
  if(undoStack.length>50)undoStack.shift();
}

/* UNDO / REDO */
function undo(btn){
  if(!undoStack.length)return;
  redoStack.push(document.getElementById("canvas").innerHTML);
  document.getElementById("canvas").innerHTML=undoStack.pop();
  restoreEvents();
}
function redo(btn){
  if(!redoStack.length)return;
  undoStack.push(document.getElementById("canvas").innerHTML);
  document.getElementById("canvas").innerHTML=redoStack.pop();
  restoreEvents();
}

/* EXPORT */
function exportPNG(){
  const c=document.querySelector(".canvas");
  html2canvas(c,{useCORS:true,scale:2}).then(canvas=>{
    const link=document.createElement("a");
    link.download="manhwa_page.png";
    link.href=canvas.toDataURL();
    link.click();
  });
}

/* ADD PANEL */
function addPanel(){
  snapshot();
  const txt=document.getElementById("scene").value.trim()||"New scene...";
  const p=document.createElement("div");
  p.className="panel";
  p.style.left="20px";
  p.style.top=(100+Math.random()*200)+"px";

  p.innerHTML=`
    <div class="bg-layer"></div>
    <div class="tools">
      <button onclick="bg(this)">BG</button>
      <button onclick="addChar(this)">CHR</button>
      <button onclick="addBubble(this)">TXT</button>
    </div>
    <div class="history">
      <button onclick="undo()">â†¶</button>
      <button onclick="redo()">â†·</button>
    </div>
    <button class="delete-panel" onclick="removeP(this)">x</button>
    <div class="caption">${txt}</div>

    <div class="resize tl"></div>
    <div class="resize tr"></div>
    <div class="resize bl"></div>
    <div class="resize br"></div>
  `;

  enableDrag(p);
  enableResize(p);
  document.getElementById("canvas").appendChild(p);
  document.getElementById("scene").value="";
}

/* BG UPLOAD */
function bg(btn){
  const p=btn.closest(".panel");
  const bg=p.querySelector(".bg-layer");
  const f=document.createElement("input");
  f.type="file";f.accept="image/*";
  f.onchange=e=>{
    snapshot();
    const r=new FileReader();
    r.onload=x=>bg.style.backgroundImage=`url(${x.target.result})`;
    r.readAsDataURL(e.target.files[0]);
  };
  f.click();
}

/* CHARACTER */
function addChar(btn){
  const p=btn.closest(".panel");
  const f=document.createElement("input");
  f.type="file";f.accept="image/*";
  f.onchange=e=>{
    snapshot();
    const img=document.createElement("img");
    img.src=URL.createObjectURL(e.target.files[0]);
    img.className="char-img";
    p.appendChild(img);
  };
  f.click();
}

/* ADD SPEECH BUBBLE */
function addBubble(btn){
  snapshot();
  const p=btn.closest(".panel");
  const b=document.createElement("div");
  b.className="bubble";
  b.contentEditable=true;
  b.innerText="Say something...";
  b.style.left="20px";
  b.style.top="20px";
  enableDrag(b);
  p.appendChild(b);
}

/* DELETE PANEL */
function removeP(btn){
  snapshot();
  btn.closest(".panel").remove();
}

/* DRAG ANY ELEMENT */
function enableDrag(el){
  let sx,sy,ox,oy;
  el.onmousedown=e=>{
    if(e.target.classList.contains("resize"))return;
    sx=e.clientX; sy=e.clientY;
    ox=el.offsetLeft; oy=el.offsetTop;
    document.onmousemove=ev=>{
      el.style.left=(ox+(ev.clientX-sx))+"px";
      el.style.top=(oy+(ev.clientY-sy))+"px";
    };
    document.onmouseup=()=>{document.onmousemove=null;}
  };
}

/* 4-corner RESIZE */
function enableResize(p){
  let sx,sy,sw,sh,sl,st;
  p.querySelectorAll(".resize").forEach(h=>{
    h.onmousedown=e=>{
      e.preventDefault();
      sx=e.clientX; sy=e.clientY;
      sw=p.offsetWidth; sh=p.offsetHeight;
      sl=p.offsetLeft; st=p.offsetTop;
      document.onmousemove=ev=>{
        const dx=ev.clientX-sx, dy=ev.clientY-sy;
        if(h.classList.contains("br")){p.style.width=(sw+dx)+"px";p.style.height=(sh+dy)+"px";}
        if(h.classList.contains("bl")){p.style.width=(sw-dx)+"px";p.style.left=(sl+dx)+"px";p.style.height=(sh+dy)+"px";}
        if(h.classList.contains("tr")){p.style.width=(sw+dx)+"px";p.style.height=(sh-dy)+"px";p.style.top=(st+dy)+"px";}
        if(h.classList.contains("tl")){p.style.width=(sw-dx)+"px";p.style.left=(sl+dx)+"px";p.style.height=(sh-dy)+"px";p.style.top=(st+dy)+"px";}
      };
      document.onmouseup=()=>{document.onmousemove=null;}
    };
  });
}

/* Restore events after undo/redo */
function restoreEvents(){
  document.querySelectorAll(".panel").forEach(p=>{
    enableDrag(p);
    enableResize(p);
  });
}
</script>

</body>
</html>
